<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Happy Birthday! ğŸ‰ ãƒãƒ¼ã‚¹ãƒ‡ãƒ¼ãƒ»ãƒãƒ«ãƒ¼ãƒ³ã‚²ãƒ¼ãƒ </title>
<meta name="description" content="30ç§’ã§ãƒãƒ«ãƒ¼ãƒ³ã‚’å‰²ã£ã¦ã‚¹ã‚³ã‚¢ã‚’ç¨¼ã”ã†ï¼ã‚±ãƒ¼ã‚­ã®ã‚ã†ããã‚’å…¨éƒ¨æ¶ˆã—ã¦ãŠç¥ã„ã—ã‚ˆã† ğŸ‚" />
<meta name="theme-color" content="#ff7bd8" />
<style>
  :root{
    --bg1:#1b0f2e;
    --bg2:#2a1051;
    --accent:#ff7bd8;
    --accent2:#ffd166;
    --good:#2dd4bf;
    --bad:#ef4444;
    --panel: rgba(255,255,255,.1);
    --glass: rgba(255,255,255,.08);
    --text:#fff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic", "Noto Sans JP", "Helvetica Neue", Arial, sans-serif;
    color: var(--text);
    background:
      radial-gradient(1200px 800px at 80% -10%, #4b1d85 0%, transparent 60%),
      radial-gradient(900px 700px at 10% 110%, #7628a4 0%, transparent 60%),
      linear-gradient(160deg, var(--bg1), var(--bg2));
    overflow:hidden;
  }
  button, input{
    font: inherit;
  }
  .wrap{
    position:relative;
    height:100%;
    width:100%;
  }

  /* Screens */
  .screen{
    position:absolute; inset:0;
    display:grid; place-items:center;
    padding:24px;
    transition: opacity .35s ease, transform .35s ease;
  }
  .screen[hidden]{opacity:0; pointer-events:none; transform: scale(.98)}
  .card{
    width:min(860px, 92vw);
    background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
    border: 1px solid rgba(255,255,255,.18);
    backdrop-filter: blur(8px);
    border-radius: 18px;
    padding: clamp(18px, 3vw, 28px);
    box-shadow: 0 20px 60px rgba(0,0,0,.35);
  }

  h1{
    margin:0 0 .2em;
    font-size: clamp(28px, 5vw, 56px);
    line-height:1.1;
    letter-spacing:.02em;
    text-wrap: balance;
  }
  .sub{
    opacity:.9;
    margin: .2em 0 1.2em;
    font-size: clamp(14px, 2.2vw, 18px);
  }
  .row{
    display:flex; gap:12px; flex-wrap:wrap; align-items:center;
    margin: 8px 0 4px;
  }
  .input{
    flex:1 1 220px;
    display:flex; gap:8px; align-items:center;
    background: var(--glass);
    border: 1px solid rgba(255,255,255,.18);
    border-radius: 12px; padding: 10px 12px;
  }
  .input label{opacity:.85; font-size:14px; white-space:nowrap}
  .input input{
    background: transparent; border:0; outline: none; color:var(--text); width:100%;
  }
  .btn{
    appearance:none; border:0; cursor:pointer; user-select:none;
    background: linear-gradient(180deg, var(--accent), #ff4dbc);
    color:#1b0730; font-weight: 800;
    padding: 12px 18px; border-radius: 12px;
    box-shadow: 0 10px 20px rgba(255, 85, 200, .35), inset 0 1px 0 rgba(255,255,255,.6);
    transition: transform .08s ease, box-shadow .2s ease, filter .1s ease;
  }
  .btn:hover{filter: brightness(1.05)}
  .btn:active{transform: translateY(1px)}
  .btn.secondary{
    background: linear-gradient(180deg, #a5b4fc, #60a5fa);
    color:#0a1a2b;
    box-shadow: 0 10px 20px rgba(96,165,250,.3), inset 0 1px 0 rgba(255,255,255,.5);
  }
  .btn.ghost{
    background: transparent; color: #fff; border:1px solid rgba(255,255,255,.35);
    box-shadow: none;
  }
  .muted{opacity:.8}

  /* Game HUD */
  .hud{
    position:absolute; top:8px; left:0; right:0;
    display:flex; align-items:center; justify-content:space-between;
    padding: 8px 12px; gap:12px; pointer-events:none;
  }
  .pill{
    pointer-events:auto;
    display:flex; align-items:center; gap:10px;
    background: var(--panel); border: 1px solid rgba(255,255,255,.18);
    border-radius: 999px; padding: 8px 12px;
  }
  .score{
    font-weight:900; font-size:clamp(18px, 4vw, 28px);
    letter-spacing:.04em;
  }
  .timer{
    --prog: 0turn;
    width: 54px; height: 54px; border-radius: 50%;
    background:
      conic-gradient(var(--accent2) var(--prog), rgba(255,255,255,.15) 0),
      radial-gradient(circle at 50% 50%, #121212 55%, transparent 56%);
    border: 2px solid rgba(255,255,255,.25);
    display:grid; place-items:center; font-weight:900;
    box-shadow: 0 6px 20px rgba(0,0,0,.3), inset 0 0 18px rgba(255,255,255,.1);
  }
  .hud .pill span{font-weight:700}

  /* Playfield */
  .field{
    position:absolute; inset:0; overflow:hidden;
  }
  .balloon{
    position:absolute; width: clamp(44px, 8vw, 80px); aspect-ratio: .8/.95;
    border-radius: 55% 55% 55% 55% / 70% 70% 40% 40%;
    box-shadow: inset -10px -14px 30px rgba(0,0,0,.15);
    transform: translate(-50%, 100%) scale(.95);
    cursor: pointer;
    will-change: transform;
  }
  .balloon::after{
    content:""; position:absolute; left:50%; bottom:-10%;
    width: 2px; height: clamp(45px, 10vh, 90px); background: rgba(255,255,255,.6);
    box-shadow: 0 0 1px rgba(255,255,255,.6);
    transform: translateX(-50%);
  }
  .float{
    animation: float-up var(--dur) linear forwards, sway 3s ease-in-out infinite alternate;
  }
  @keyframes float-up{
    from{ transform: translate(var(--x, -50%), 100%) scale(1) rotate(0deg);}
    to  { transform: translate(var(--x, -50%), -130%) scale(1.05) rotate(2deg);}
  }
  @keyframes sway{
    from{ margin-left:-6px } to { margin-left:6px }
  }
  .pop{
    animation: pop .18s ease-out forwards;
  }
  @keyframes pop{
    0%{ transform: translate(var(--x, -50%), var(--y, 0)) scale(1) }
    80%{ transform: translate(var(--x, -50%), var(--y, 0)) scale(1.2) }
    100%{ transform: translate(var(--x, -50%), var(--y, 0)) scale(.2); opacity:0 }
  }
  .spark{
    position:absolute; width:6px; height:6px; border-radius:50%;
    pointer-events:none;
  }

  /* Finish / Cake */
  .center{
    text-align:center;
  }
  .result{
    font-size: clamp(22px, 4.5vw, 38px); font-weight: 900; margin:.2em 0 .6em;
  }

  .cakeArea{
    margin-top: 14px;
    display:grid; place-items:center;
  }
  .cake{
    position:relative;
    width:min(420px, 80vw); height: 220px;
    background: linear-gradient(#ffe0f3, #ffc4e9);
    border-radius: 14px 14px 40px 40px;
    border:2px solid rgba(255,255,255,.6);
    box-shadow: inset 0 -10px 0 #ff99d1, inset 0 -24px 0 #ff7bc4, 0 10px 40px rgba(0,0,0,.25);
  }
  .cake::before{
    content:""; position:absolute; left:0; right:0; top:-22px; height:30px;
    background:
      radial-gradient(circle at 20px 14px, #fff 0 10px, transparent 11px) repeat-x 0 0/40px 30px,
      linear-gradient(#fff, #ffe6f7);
    border-radius: 14px 14px 0 0; border:2px solid rgba(255,255,255,.6);
    border-bottom:0;
  }
  .candles{
    position:absolute; left:0; right:0; top:-10px; display:flex; justify-content:center; gap:18px;
  }
  .candle{
    width: 14px; height: 56px; border-radius: 6px;
    background: repeating-linear-gradient( 90deg, #ffd4e8 0 6px, #ff91c7 6px 12px );
    border:1px solid rgba(0,0,0,.08);
    position:relative; cursor:pointer;
  }
  .candle .flame{
    --glow: rgba(255, 215, 97, .8);
    position:absolute; left:50%; top:-18px; transform: translateX(-50%);
    width: 14px; height: 18px; border-radius: 10px 10px 10px 10px / 14px 14px 8px 8px;
    background: radial-gradient(circle at 50% 30%, #fff 0 35%, #ffd166 36% 60%, #ff9900 61% 100%);
    box-shadow: 0 0 12px 4px var(--glow), 0 0 30px 10px rgba(255, 184, 0, .4);
    animation: flicker .8s ease-in-out infinite;
  }
  @keyframes flicker{
    0%,100%{ transform: translateX(-50%) scale(1) }
    50%{ transform: translateX(-50%) scale(1.05) }
  }

  /* Confetti canvas sits on top */
  canvas#fx{
    position:absolute; inset:0; pointer-events:none;
  }

  /* Accessibility: reduced motion */
  @media (prefers-reduced-motion: reduce){
    .float, .sway, .flicker, .pop{animation: none}
    .balloon{transition:none}
  }

  /* Footer */
  .foot{
    position:absolute; bottom:8px; left:0; right:0; text-align:center;
    opacity:.75; font-size:12px;
  }
  .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: rgba(255,255,255,.17); padding:2px 6px; border-radius:6px}

</style>
</head>
<body>
<div class="wrap">
  <!-- Start Screen -->
  <section id="start" class="screen">
    <div class="card">
      <h1>ğŸ‰ Happy Birthday! / ãŠãŸã‚“ã˜ã‚‡ã†ã³ ãŠã‚ã§ã¨ã†ï¼</h1>
      <p class="sub">30ç§’ã§ <b>ğŸˆãƒãƒ«ãƒ¼ãƒ³ã‚’ã§ãã‚‹ã ã‘å‰²ã£ã¦</b> ã‚¹ã‚³ã‚¢ã‚’ç¨¼ã”ã†ã€‚ã‚²ãƒ¼ãƒ ã®ã‚ã¨ã« <b>ğŸ‚ã‚±ãƒ¼ã‚­ã®ã‚ã†ãã</b> ã‚’æ¶ˆã—ã¦ãŠç¥ã„ï¼</p>
      <div class="row">
        <div class="input">
          <label for="name">ãŠãªã¾ãˆ</label>
          <input id="name" type="text" placeholder="ä¾‹ï¼‰ã•ãã‚‰ / Taro" autocomplete="nickname">
        </div>
        <div class="input" style="max-width:200px">
          <label for="age">ã­ã‚“ã‚Œã„</label>
          <input id="age" type="number" min="1" max="120" inputmode="numeric" placeholder="ä¾‹ï¼‰7">
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="playBtn">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button class="btn ghost" id="howBtn">ã‚ãã³ã‹ãŸ</button>
      </div>
      <details style="margin-top:10px">
        <summary class="muted">è¨­å®šï¼ˆã‚«ãƒ©ãƒ¼ãƒ»åŠ¹æœï¼‰</summary>
        <div class="row" style="margin-top:8px">
          <div class="input" style="max-width:220px">
            <label for="color">ãƒ†ãƒ¼ãƒ</label>
            <input id="color" type="color" value="#ff7bd8" />
          </div>
          <div class="input" style="max-width:260px">
            <label for="duration">åˆ¶é™æ™‚é–“</label>
            <input id="duration" type="range" min="15" max="60" value="30" oninput="durationOut.textContent=this.value+' ç§’'">
            <span id="durationOut" aria-hidden="true">30 ç§’</span>
          </div>
        </div>
      </details>
    </div>
  </section>

  <!-- How to -->
  <section id="how" class="screen" hidden>
    <div class="card">
      <h1>ã‚ãã³ã‹ãŸ</h1>
      <ul style="line-height:1.9; margin:0 0 10px 1.2em">
        <li>30ç§’é–“ã€ç”»é¢ã«ã‚ãŒã£ã¦ãã‚‹ <b>ãƒãƒ«ãƒ¼ãƒ³ã‚’ã‚¿ãƒƒãƒ— / ã‚¯ãƒªãƒƒã‚¯</b> ã—ã¦å‰²ã‚ã†ã€‚</li>
        <li>æ™®é€šã®ãƒãƒ«ãƒ¼ãƒ³ = <b>+1ç‚¹</b>ã€ã‚­ãƒ©â­ãƒãƒ«ãƒ¼ãƒ³ = <b>+3ç‚¹</b>ï¼</li>
        <li><span class="kbd">R</span> ã§ã‚‚ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã§ãã‚‹ã‚ˆã€‚</li>
      </ul>
      <div class="row">
        <button class="btn secondary" id="backBtn">OK, ã¯ã˜ã‚ã‚‹</button>
      </div>
    </div>
  </section>

  <!-- Game Screen -->
  <section id="game" class="screen" hidden>
    <div class="hud">
      <div class="pill"><span>â±ï¸</span><div class="timer" id="timer"><span id="timeLeft">30</span></div></div>
      <div class="pill"><span>ğŸ§‘â€ğŸ‚</span><span id="playerName">Guest</span></div>
      <div class="pill"><span>â­</span><div class="score"><span id="score">0</span> pt</div></div>
    </div>
    <div class="field" id="field" aria-label="ã‚²ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰"></div>
    <canvas id="fx"></canvas>
  </section>

  <!-- Result Screen -->
  <section id="result" class="screen" hidden>
    <div class="card center">
      <div style="font-size:42px">ğŸ‰</div>
      <div class="result"><span id="hello"></span> ã‚¹ã‚³ã‚¢ã¯ <span id="finalScore">0</span> ç‚¹ï¼</div>
      <div class="muted" id="rankText">ãŒã‚“ã°ã£ãŸã­ï¼</div>

      <div class="cakeArea" id="cakeArea">
        <div style="margin:.6em 0 .3em">ã‚ã†ããã‚’å…¨éƒ¨ã‚¯ãƒªãƒƒã‚¯ / ã‚¿ãƒƒãƒ—ã—ã¦æ¶ˆã—ã¦ã­</div>
        <div class="cake" role="img" aria-label="ãŠèª•ç”Ÿæ—¥ã‚±ãƒ¼ã‚­">
          <div class="candles" id="candles"></div>
        </div>
      </div>

      <div class="row" style="justify-content:center; margin-top:16px">
        <button class="btn secondary" id="shareBtn">çµæœã‚’ã‚·ã‚§ã‚¢</button>
        <button class="btn" id="againBtn">ã‚‚ã†ä¸€å›</button>
      </div>
    </div>
  </section>

  <div class="foot">Â© Birthday Game Â· <span class="muted">ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ <span class="kbd">R</span> ã§å†ã‚¹ã‚¿ãƒ¼ãƒˆ</span></div>
</div>

<script>
(() => {
  const $ = (q, el=document) => el.querySelector(q);
  const $all = (q, el=document) => [...el.querySelectorAll(q)];

  // Elements
  const screens = {
    start: $("#start"),
    how: $("#how"),
    game: $("#game"),
    result: $("#result")
  };
  const field = $("#field");
  const scoreEl = $("#score");
  const timeEl = $("#timeLeft");
  const timerRing = $("#timer");
  const fxCanvas = $("#fx");
  const ctx = fxCanvas.getContext("2d");
  const playerNameEl = $("#playerName");
  const nameInput = $("#name");
  const ageInput = $("#age");
  const colorInput = $("#color");
  const durationInput = $("#duration");
  const finalScoreEl = $("#finalScore");
  const helloEl = $("#hello");
  const shareBtn = $("#shareBtn");
  const againBtn = $("#againBtn");
  const playBtn = $("#playBtn");
  const howBtn = $("#howBtn");
  const backBtn = $("#backBtn");
  const candlesWrap = $("#candles");
  const cakeArea = $("#cakeArea");
  const rankText = $("#rankText");

  // State
  let state = {
    name: "Guest",
    age: null,
    score: 0,
    timeLeft: 30,
    running: false,
    loopId: null,
    spawnTimer: 0,
    spawnEvery: 700, // ms
    lastTick: 0,
    balloons: new Set(),
    specialRate: 0.18, // 18% special â­
  };

  // Utils
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const rand = (a, b) => a + Math.random() * (b - a);
  const pick = arr => arr[(Math.random() * arr.length) | 0];

  // Resize canvas
  const fitCanvas = () => {
    fxCanvas.width = field.clientWidth;
    fxCanvas.height = field.clientHeight;
  };
  addEventListener("resize", fitCanvas, {passive:true});
  const setTheme = (hex) => {
    document.documentElement.style.setProperty("--accent", hex);
  };

  // Screens
  const show = id => {
    for (const key in screens) {
      screens[key].hidden = key !== id;
    }
  };

  // Confetti particles
  const confetti = [];
  function burst(x, y, count=24){
    for(let i=0;i<count;i++){
      confetti.push({
        x, y,
        vx: Math.cos((i/count)*Math.PI*2) * rand(2,5),
        vy: Math.sin((i/count)*Math.PI*2) * rand(2,5) - rand(2,6),
        g: .12,
        life: rand(40,70),
        r: rand(2,4),
        color: pick(["#ffd166","#ff7bd8","#7dd3fc","#a7f3d0","#fdba74","#fca5a5"])
      });
    }
  }

  function drawFX(){
    ctx.clearRect(0,0,fxCanvas.width, fxCanvas.height);
    for(let i=confetti.length-1;i>=0;i--){
      const p = confetti[i];
      p.vy += p.g;
      p.x += p.vx;
      p.y += p.vy;
      p.life -= 1;
      ctx.fillStyle = p.color;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fill();
      if(p.life<=0 || p.y>fxCanvas.height+20) confetti.splice(i,1);
    }
    requestAnimationFrame(drawFX);
  }

  // Balloon creation
  const balloonColors = [
    ["#ff9fdc","#ff7bd8"],
    ["#ffe48c","#ffd166"],
    ["#9bf0ff","#7dd3fc"],
    ["#b2f5ea","#2dd4bf"],
    ["#c4b5fd","#a78bfa"],
    ["#fecaca","#fca5a5"],
    ["#fde68a","#fbbf24"]
  ];
  function makeBalloon(){
    const b = document.createElement("div");
    b.className = "balloon float";
    const isSpecial = Math.random() < state.specialRate;
    const [c1,c2] = isSpecial ? ["#fff6a6","#ffd166"] : pick(balloonColors);
    const left = rand(10, 90);
    const dur = rand(7, 13); // seconds
    b.style.left = left + "%";
    b.style.setProperty("--x", "-50%");
    b.style.setProperty("--dur", dur+"s");
    b.style.background = `radial-gradient(120% 120% at 30% 30%, rgba(255,255,255,.85), ${c1} 35%, ${c2})`;
    if(isSpecial){
      // star overlay
      b.style.boxShadow = "0 0 0 2px rgba(255,255,255,.4) inset, 0 0 30px rgba(255, 209, 102, .35)";
      b.dataset.special = "1";
      const star = document.createElement("div");
      star.textContent = "â­";
      star.style.position="absolute";
      star.style.inset="0";
      star.style.display="grid";
      star.style.placeItems="center";
      star.style.fontSize="clamp(22px, 4vw, 36px)";
      star.style.opacity=".9";
      b.appendChild(star);
    }

    // Remove when out of view
    const cleanup = () => {
      b.removeEventListener("animationend", cleanup);
      state.balloons.delete(b);
      b.remove();
    };
    b.addEventListener("animationend", cleanup, {once:true});

    // Pop handler
    const pop = (ev) => {
      if(!state.running) return;
      ev.stopPropagation();
      const rect = b.getBoundingClientRect();
      burst(rect.left + rect.width/2, rect.top + rect.height/2, isSpecial ? 30 : 16);
      b.classList.remove("float");
      b.classList.add("pop");
      b.style.setProperty("--y", "0");
      b.removeEventListener("pointerdown", pop);
      b.addEventListener("animationend", () => {
        state.balloons.delete(b);
        b.remove();
      }, {once:true});
      addScore(isSpecial ? 3 : 1);
    };
    b.addEventListener("pointerdown", pop);

    state.balloons.add(b);
    field.appendChild(b);
  }

  // Score & timer
  function addScore(n){
    state.score += n;
    scoreEl.textContent = state.score;
    scoreEl.animate([{transform:"scale(1)"},{transform:"scale(1.18)"},{transform:"scale(1)"}], {duration:180, easing:"ease-out"});
  }
  function updateTimerUI(){
    timeEl.textContent = Math.ceil(state.timeLeft);
    const p = Math.max(0, state.timeLeft) / state.totalTime;
    timerRing.style.setProperty("--prog", (1-p)+"turn");
  }

  // Game loop
  function startGame(){
    fitCanvas();
    state.name = (nameInput.value || "Guest").trim().slice(0,20);
    playerNameEl.textContent = state.name;
    state.age = clamp(parseInt(ageInput.value||"7",10)||7, 1, 120);
    state.totalTime = clamp(parseInt(durationInput.value,10)||30, 10, 180);
    state.timeLeft = state.totalTime;
    state.score = 0;
    state.spawnEvery = 700;
    state.lastTick = performance.now();
    scoreEl.textContent = "0";
    timeEl.textContent = state.totalTime;
    timerRing.style.setProperty("--prog", "0turn");
    state.running = true;

    // clear old balloons
    state.balloons.forEach(b => b.remove());
    state.balloons.clear();

    // start loop
    cancelAnimationFrame(state.loopId);
    drawFX(); // ensures FX loop running
    loop();
  }

  function loop(now=performance.now()){
    if(!state.running) return;
    const dt = now - state.lastTick;
    state.lastTick = now;

    // time
    state.timeLeft -= dt/1000;
    updateTimerUI();

    // spawn balloons
    state.spawnTimer += dt;
    const dynamicRate = clamp(700 - ( (state.totalTime - state.timeLeft) / state.totalTime )*300, 380, 700);
    const rate = dynamicRate;
    if(state.spawnTimer >= rate){
      state.spawnTimer = 0;
      // spawn 1~2 balloons occasionally
      const count = Math.random() < 0.25 ? 2 : 1;
      for(let i=0;i<count;i++) makeBalloon();
    }

    // end
    if(state.timeLeft <= 0){
      endGame();
      return;
    }
    state.loopId = requestAnimationFrame(loop);
  }

  function endGame(){
    state.running = false;
    cancelAnimationFrame(state.loopId);
    // remove remaining balloons gracefully
    state.balloons.forEach(b => b.remove());
    state.balloons.clear();

    // Result
    finalScoreEl.textContent = state.score;
    helloEl.textContent = state.name;
    rankText.textContent = getPraise(state.score);

    // Build cake & candles
    buildCandles();
    // Screen switch
    show("result");
    // celebratory burst
    setTimeout(()=>{
      burst(fxCanvas.width*.25, fxCanvas.height*.2, 50);
      burst(fxCanvas.width*.75, fxCanvas.height*.28, 50);
      burst(fxCanvas.width*.50, fxCanvas.height*.3, 60);
    }, 50);
  }

  function getPraise(score){
    if(score >= 60) return "æœ€å¼·ï¼ã‚ãªãŸã¯ãƒãƒ«ãƒ¼ãƒ³ãƒ»ãƒã‚¹ã‚¿ãƒ¼ï¼";
    if(score >= 40) return "ã™ã”ã„ï¼ã¨ã£ã¦ã‚‚ä¸Šæ‰‹ï¼";
    if(score >= 25) return "ãƒŠã‚¤ã‚¹ï¼ãã®èª¿å­ï¼";
    if(score >= 10) return "ã‚°ãƒƒãƒ‰ï¼ã¾ã ã¾ã ã„ã‘ã‚‹ï¼";
    return "ãŒã‚“ã°ã£ãŸã­ï¼ã‚‚ã†ä¸€å›ã‚„ã£ã¦ã¿ã‚ˆã†ï¼";
  }

  // Cake & candles
  function buildCandles(){
    candlesWrap.innerHTML = "";
    const count = clamp(state.age || 7, 1, 10); // ã‚ã†ããã¯æœ€å¤§10æœ¬
    for(let i=0;i<count;i++){
      const c = document.createElement("div");
      c.className="candle";
      const flame = document.createElement("div");
      flame.className="flame";
      c.appendChild(flame);
      c.title = "ãµãƒ¼ã£ï¼ˆã‚¯ãƒªãƒƒã‚¯ï¼ã‚¿ãƒƒãƒ—ã§æ¶ˆãˆã‚‹ã‚ˆï¼‰";
      c.addEventListener("pointerdown", () => {
        if(flame){
          flame.remove();
          burst(c.getBoundingClientRect().left + 7, c.getBoundingClientRect().top - 6, 18);
          checkAllExtinguished();
        }
      }, {passive:false});
      candlesWrap.appendChild(c);
    }
  }
  function checkAllExtinguished(){
    const left = $all(".candle .flame", candlesWrap).length;
    if(left===0){
      // fireworks burst rain
      for(let i=0;i<8;i++){
        setTimeout(()=>{
          burst(rand(40, fxCanvas.width-40), rand(40, fxCanvas.height*0.4), 70);
        }, 120*i);
      }
      const msg = document.createElement("div");
      msg.textContent = "ãŠã‚ã§ã¨ã†ï¼ ğŸ‚";
      msg.style.fontSize = "clamp(26px, 6vw, 52px)";
      msg.style.fontWeight = "900";
      msg.style.marginTop = "12px";
      msg.style.textShadow = "0 6px 30px rgba(0,0,0,.35)";
      cakeArea.appendChild(msg);
    }
  }

  // Share
  async function shareScore(){
    const shareText = `ğŸ‰ ${state.name}ã®ãƒãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¹ã‚³ã‚¢: ${state.score}ç‚¹ï¼ #BirthdayBalloons`;
    const shareData = {
      title: "Birthday Balloons",
      text: shareText,
      url: location.href
    };
    try{
      if(navigator.share){
        await navigator.share(shareData);
      }else{
        await navigator.clipboard.writeText(shareText + " " + location.href);
        shareBtn.textContent = "ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼";
        setTimeout(()=> shareBtn.textContent = "çµæœã‚’ã‚·ã‚§ã‚¢", 1400);
      }
    }catch(e){
      console.log(e);
    }
  }

  // Interactions
  playBtn.addEventListener("click", () => {
    setTheme(colorInput.value || "#ff7bd8");
    show("game");
    startGame();
  });
  howBtn.addEventListener("click", () => show("how"));
  backBtn.addEventListener("click", () => show("start"));
  againBtn.addEventListener("click", () => {
    show("game");
    startGame();
  });
  shareBtn.addEventListener("click", shareScore);

  // Keyboard shortcuts
  addEventListener("keydown", (e) => {
    if(e.key.toLowerCase()==="r"){
      show("game"); startGame();
    }
  });

  // Init
  show("start");
  fitCanvas();

  // Click anywhere in field to create a tiny spark (fun)
  field.addEventListener("pointerdown", (e) => {
    if(!state.running) return;
    const rect = field.getBoundingClientRect();
    burst(e.clientX - rect.left, e.clientY - rect.top, 10);
  });

  // Respect chosen color
  colorInput.addEventListener("input", (e)=> setTheme(e.target.value));

})();
</script>
</body>
</html>
